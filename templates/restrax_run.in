#!/bin/sh
##################################################################
#  *****  script for starting RESTRAX  *****
#
# RESTRAX can be started by calling the executable directly, but this 
# script helps to set properly the environment and command-line options.
# Look also in the initialization file "restrax.ini", which should be
# found in the <cfgfiles> directory.
# 
# Syntax: restrax_run <cfg> <exci> [<options>]
# where 
# <cfgfiles> ... absolute path to the directory with instrument configurations 
# <exci>     ... EXCI library to be loaded at start-up
# <options>  ... additional command line options   
###################################################################

#------------------------------------------------------------------
# Edit following to match your local environment
#------------------------------------------------------------------
# path to RESTRAX installation
INSTDIR=@INSTDIR@
# RESTRAX executable
RESTRAX=@INSTDIR@/bin/@EXENAME@
# PGPLOT directory
PG=@INSTDIR@/@PGPLOT_DIR@

# Absolute path to the RESTRAX configurations and/or lookup tables:
CFGFILES=$1

# string with command line options
STDOPT=$2

#------------------------------------------------------------------
# search for PGPLOT
#-------------------------------------------------------------------

PGPATH="$PG $PGPLOT_DIR /usr/local/pgplot /usr/local/lib "
PGPLOT=""
for F in $PGPATH
do
	if test -f $F/grfont.dat ; then
		PGPLOT=$F
		echo "PGPLOT found at $PGPLOT"
		break
	fi
done

PGPLOT_DIR=$PGPLOT
PGPLOT_FONT=$PGPLOT/grfont.dat
# your printer command
if test $PRINTER ; then 
	PGPLOT_ILL_PRINT_CMD="lp -d$PRINTER ";
else
	PGPLOT_ILL_PRINT_CMD="lpr ";
fi

# default PGPLOT device
PGPLOT_DEV=/xserv

if test -z $PGPLOT ; then
	echo "Cannot find PGPLOT!"
	echo "continue? [y/n]"
	read ANSW
	if [ $ANSW != "y" ] ; then
		exit
	else
		echo "PGPLOT output redirected to /NULL"
		PGPLOT_DEV="/NULL"	
	fi
fi

export PGPLOT_DIR PGPLOT_DEV PGPLOT_FONT PGPLOT_ILL_PRINT_CMD

#------------------------------------------------------------------
# There is nothing to modify below
#-------------------------------------------------------------------

# path to link shared libraries (for lib_res_exci.so)
# there are 2 versions for Unix and HP_UX
LD_LIBRARY_PATH=.:$PGPLOT_DIR:$LD_LIBRARY_PATH
SHLIB_PATH=.:$PGPLOT_DIR:$SHLIB_PATH
export LD_LIBRARY_PATH SHLIB_PATH

# start RESTRAX
# If there is $3 defined, it is interpreted as a list of input files
# They are executed simultaneously in the background !!!
# input=$3.inp, output=$3.out, logfile=$3.log 


if [ "a$3" != "a" ] ; then 

	for F in $3
	do
		echo $F.inp > tmp$F.cmd
		echo $F.out >> tmp$F.cmd	
		$RESTRAX -dir=$CFGFILES $STDOPT < tmp$F.cmd 1> $F.log 2> /dev/null &
	done
else
	$RESTRAX -dir=$CFGFILES $STDOPT ;
fi



